[[xplanmanager-api]]
=== XPlanManagerAPI

Die REST-API des XPlanManager ermöglicht es, die Funktionen des XPlanManager über eine Web-API aufzurufen. Bei der Festlegung der Ressourcen wurden Begriffe aus drei Domänen verwendet. Die REST-API Ressourcen wie z.B. `/plan` oder `/info` sind in Englisch und der Einstiegspunkt für eine Entität. Ressourcen unterhalb einer Entität wie z.B. `/plan/{planId}/aenderung` oder `/plan/{planId}/gueltigkeit` sind in Deutsch und aus der Oberfläche des XPlanManagerWeb abgeleitet. Die verwendeten Datentypen sind ebenfalls in Deutsch und aus den Bezeichnern des XPlanung-Datenmodells (XPlanGML-Applikationsschema) abgeleitet. Bezeichner wie z. B. `{planId}` in einer Ressource sind Variablen und müssen durch entsprechende Werte ausgetauscht werden. Folgende Variablen werden in der API verwendet:

- `{planId}` - eindeutiger Schlüssel eines Plans (numerischer Wert, z.B. 10)
- `{planName}` - eindeutiger Name eines Plans (alphanumerischer Wert, z.B. HafenCity14)
- `{name}` - Name oder Suchtext (alphanumerischer Wert, z.B. Hafen )
- `{id}` - eindeutiger Schlüssel einer Ressource (alphanumerischer Wert, Beispiele siehe Abschnitt <<xplanmanager-api-schluessel, eindeutige Schlüssel>>)

Die REST-API des XPlanManager stellt folgende Ressourcen bereit:

[width="100%",cols="25%,15%,60%",options="header",]
|===
|Ressource |HTTP Methode |Beschreibung
|`/` |`GET` |Beschreibung der Schnittstelle als OpenAPI 3.0 Dokument
|`/info` |`GET` |Informationen zur xPlanBox Version und aktiven Konfiguration
|`/plan` |`POST` |Importieren eines XPlanGML-Dokuments oder XPlanArchivs
|`/plan/{planId}` |`GET` |Abfrage der Daten zu einem XPlanArchiv über PlanID
|`/plan/{planId}` |`DELETE` |Löschen eines XPlanArchivs
|`/plan/name/{planName}` |`GET` |Abfrage der Daten zu einem XPlanArchiv über den Plannamen
|`/plans?planName={name}` |`GET` |Suche nach XPlanArchiven über den Plannamen
|`/plan/{planId}/basisdaten` |`GET` |Abfrage von Basisdaten zu einem Plan
|`/plan/{planId}/basisdaten` |`PUT` |Hinzufügen/ersetzen von Basisdaten zu einem Plan
|`/plan/{planId}/gueltigkeit` |`GET` |Abfrage des Gültigkeitzeitraums zu einem Plan
|`/plan/{planId}/gueltigkeit` |`PUT` |Hinzufügen/ersetzen des Gültigkeitzeitraums zu einem Plan
|`/plan/{planId}/aenderungen` |`GET` |Abfrage von Änderungen zu einem Plan
|`/plan/{planId}/aenderungen` |`PUT` |Hinzufügen von Änderungen zu einem Plan
|`/plan/{planId}/dokument` |`GET` |Abfrage von Dokumenten zu einem Plan
|`/plan/{planId}/dokument` |`POST` |Hinzufügen/ersetzen von Dokumenten zu einem Plan
|`/plan/{planId}/dokument/{id}` |`GET` |Abfrage eines Dokuments zu einem Plan
|`/plan/{planId}/dokument/{id}` |`PUT` |Hinzufügen/ersetzen eines Dokuments zu einem Plan
|`/plan/{planId}/dokument/{id}` |`DELETE` |Entfernen eines Dokuments zu einem Plan
|`/plan/{planId}/text` |`GET` |Abfrage von Texten zu einem Plan
|`/plan/{planId}/text` |`POST` |Hinzufügen von Texten zu einem Plan
|`/plan/{planId}/text/{id}` |`GET` |Abfrage eines Texts zu einem Plan
|`/plan/{planId}/text/{id}` |`PUT` |Hinzufügen/ersetzen eines Texts zu einem Plan
|`/plan/{planId}/rasterbasis` |`GET` |Abfrage von Rasterbasisdateien zu einem Plan
|`/plan/{planId}/rasterbasis` |`PUT` |Hinzufügen von Rasterbasisdateien zu einem Plan
|`/plan/{planId}/rasterbasis/{id}` |`GET` |Abfrage einer Rasterbasisdatei zu einem Plan
|`/plan/{planId}/rasterbasis/{id}` |`PUT` |Hinzufügen/ersetzen einer Rasterbasisdatei zu einem Plan
|`/plan/{planId}/rasterbasis/{id}` |`DELETE` |Entfernen einer Rasterbasisdatei zu einem Plan
|===

Neben dem Datenformat JSON unterstützt die REST-API auch andere Inhaltstypen, die das Datenformat JSON (Inhaltstyp `application/json`) genauer beschreiben. Im Rahmen der Inhaltsvereinbarung zwischen Client und Server über das HTTP-Header-Feld `Accept` können auch die Inhaltstypen (media types) `application/vnd.xplanbox.api+json`, `application/vnd.xplanbox.api.v1+json` und `application/vnd.xplanbox.api.v2+json` angefragt werden. Einzelne Ressourcen wie z.B. `POST /plan` unterstützen diese anwendungsspezifischen Datentypen.

Eine vollständige Beschreibung der HTTP Status-Codes und der unterstützten Inhaltstypen (media types) und Formate (Encodings) für die jeweiligen Ressourcen sind in der OpenAPI-Schnittstellenbeschreibung enthalten.

NOTE: Die URL für die REST-API des XPlanManager setzt sich wie folgt zusammen: http://<host>:<port>/xplan-api-manager/xmanager/api/v1/. Die URL für die xPlanBox-Demo lautet https://xplanbox.lat-lon.de/xmanager/api/v1/.

IMPORTANT: Die alte REST-API mit den Ressourcen `/xplanmgrweb/rest/manager/plans` und `/xplanmgrweb/rest/manager/plan/{planId}` wird durch die neue
API komplett ersetzt und in einer zukünftigen Version der xPlanBox entfernt!

[[xplanmanager-api-schluessel]]
==== Eindeutige Schlüssel für den Zugriff auf REST-Ressourcen

Um den Zugriff auf externe Dokumente zu ermöglichen, die über Referenzen in dem XPlanGML-Dokument definiert sind, wurden folgende Konventionen für die Bestimmung eines eindeutigen Schlüssels festgelegt. Diese Konventionen müssen von einem XPlanArchiv erfüllt werden, wenn dieses über die REST-API bearbeitet werden soll.
Im Folgenden sind die Konventionen am Beispiel der Planart "BPlan" und die jeweilige XPlanGML-Version aufgeführt.

Ressource: `/plan/{planId}/text/{id}`
[width="100%",cols="20%,60%,20%",options="header",]
|===
|XPlanGML-Version |Element |ID
|4.1 	|BP_Plan/texte => BP_TextAbschnitt (FeatureType) 	|GML ID
|5.0 	|BP_Plan/texte => BP_TextAbschnitt (FeatureType) 	|GML ID
|5.1 	|BP_Plan/texte => BP_TextAbschnitt (FeatureType) 	|GML ID
|5.2 	|BP_Plan/texte => BP_TextAbschnitt (FeatureType) 	|GML ID
|5.3 	|BP_Plan/texte => BP_TextAbschnitt (FeatureType) 	|GML ID
|5.4 	|BP_Plan/texte => BP_TextAbschnitt (FeatureType) 	|GML ID
|6.0 	|BP_Plan/texte => BP_TextAbschnitt (FeatureType) 	|GML ID
|===

Ressource: `/plan/{planId}/dokument/{id}`
[width="100%",cols="10%,30%,30%,30%",options="header",]
|===
|Version 	|Element 	|Konformitätsregel 	|ID
|4.1 	|BP_Plan/ref*/XP_ExterneReferenz          |	|referenzName-referenzURLfootnote:pattern[andere Zeichen als `a-z, A-Z, 0-9, _, -` werden entfernt!]
|5.0 	|BP_Plan/externeRefenz/XP_ExterneReferenz | |referenzName-referenzURLfootnote:pattern[]
|5.1 	|BP_Plan/externeRefenz/XP_ExterneReferenz | |referenzName-referenzURLfootnote:pattern[]
|5.2 	|BP_Plan/externeRefenz/XP_ExterneReferenz | |referenzName-referenzURLfootnote:pattern[]
|5.3 	|BP_Plan/externeRefenz/XP_ExterneReferenz |3.2.4.2. Mindestens eines der Attribute referenzName und referenzURL muss belegt sein. |referenzName-referenzURLfootnote:pattern[]
|5.4 	|BP_Plan/externeRefenz/XP_ExterneReferenz |3.2.4.2. Mindestens eines der Attribute referenzName und referenzURL muss belegt sein. |referenzName-referenzURLfootnote:pattern[]
|6.0 	|BP_Plan/externeRefenz/XP_ExterneReferenz |3.2.4.2. Mindestens eines der Attribute referenzName und referenzURL muss belegt sein. |referenzName-referenzURLfootnote:pattern[]
|===

Ressource: `/plan/{planId}/rasterbasis/{id}`
[width="100%",cols="10%,30%,30%,30%",options="header",]
|===
|Version 	|Element 	|Konformitätsregel 	|ID
|4.1 	|BP_Bereich/rasterBasis => XP_RasterplanBasis/refScan | 	  	|referenzName-referenzURLfootnote:pattern[]
|5.0 	|BP_Bereich/rasterBasis => XP_RasterplanBasis/refScan, BP_Bereich/refScan/XP_ExterneReferenz |	  	|referenzName-referenzURLfootnote:pattern[]
|5.1 	|BP_Bereich/rasterBasis => XP_RasterplanBasis/refScan, BP_Bereich/refScan/XP_ExterneReferenz |	  	|referenzName-referenzURLfootnote:pattern[]
|5.2 	|BP_Bereich/rasterBasis => XP_RasterplanBasis/refScan, BP_Bereich/refScan/XP_ExterneReferenz |	  	|referenzName-referenzURLfootnote:pattern[]
|5.3 	|BP_Bereich/rasterBasis => XP_RasterplanBasis/refScan, BP_Bereich/refScan/XP_ExterneReferenz |3.2.4.2. Mindestens eines der Attribute referenzName und referenzURL muss belegt sein. 	|referenzName-referenzURLfootnote:pattern[]
|5.4 	|BP_Bereich/rasterBasis => XP_RasterplanBasis/refScan, BP_Bereich/refScan/XP_ExterneReferenz |3.2.4.2. Mindestens eines der Attribute referenzName und referenzURL muss belegt sein. 	|referenzName-referenzURLfootnote:pattern[]
|6.0 	|BP_Bereich/refScan/XP_ExterneReferenz 	|3.2.4.2. Mindestens eines der Attribute referenzName und referenzURL muss belegt sein. |referenzName-referenzURLfootnote:pattern[]
|===

Zusätzliche Anforderungen an die im XPlanGML-Dokument verlinkten Referenzen:

- Für alle Dokumente und Rasterbasis in der Version 4.1 bis 5.2 gilt, dass _referenzName_ oder _referenzURL_ belegt sein muss.
- Für Pläne mit mehreren `BP_Bereich`-Elementen muss das Element `nummer` für jeden `BP_Bereich` eindeutig sein.
- Und zusätzlich gilt für alle Dokumente und Rasterbasis, dass die Kombination aus _referenzName-referenzURL_ innerhalb eines XPlanGML-Dokuments eindeutig sein muss.
