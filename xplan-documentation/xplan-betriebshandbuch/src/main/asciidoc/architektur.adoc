[[systemarchitektur-und-schnittstellen]]
== Systemarchitektur und Schnittstellen

Das Gesamtsystem setzt sich aus folgenden Komponenten zusammen:

* <<xplanmanager-web, XPlanManagerWeb>>
* <<xplanmanager-api, XPlanManagerAPI>>
* <<xplanmanager-cli, XPlanManagerCLI>>
* <<xplanvalidator-web, XPlanValidatorWeb>> inkl. <<xplanvalidator-wms, XPlanValidatorWMS>>
* <<xplanvalidator-api, XPlanValidatorAPI>>
* <<xplanvalidator-cli, XPlanValidatorCLI>>
* <<xplantransform-cli, XPlanTransformCLI>>
* <<xplanevaluationschemasynchronize-cli, XPlanAuswerteschemaCLI>>
* <<xplanwms, XPlanWMS und XPlanWerkWMS>>
* <<xplanwfs, XPlanWFS>>
* <<xplansynwfs, XPlanSynWFS>>
* <<xplaninspirepluwms, XPlanInspirePluWMS>>
* <<xplaninspirepluwfs, XPlanInspirePluWFS>>
* <<xplanresources, XPlanRessourcen>>
* <<xplandb, XPlanDB>>

.Einfache Datenhaltung der XPlanDB
image::Architektur_xPlanBox_einfach.png[Einfache Darstellung]

.Separate Datenhaltung der XPlanDB - getrennt nach Planstatus
image::Architektur_xPlanBox_komplex.png[Komplexe Darstellung]

[[xplanmanager-web]]
=== XPlanManagerWeb

Die Komponente XPlanManagerWeb ist eine Web-Oberfläche, die dem
Fachadministrator der xPlanBox ermöglicht,
die Datenhaltung <<XPlanDB>> über einen Browser zu verwalten.

[[xplanmanager-api]]
=== XPlanManagerAPI

Die Komponente XPlanManagerAPI stellt eine REST-Schnittstelle bereit, über die
die Datenhaltung <<XPlanDB>> verwaltet werden kann.

[[xplanmanager-cli]]
=== XPlanManagerCLI

Die Komponente XPlanManagerCLI ist ein Kommandozeilenwerkzeug, welches
dem Fachadministrator der xPlanBox ermöglicht,
die Datenhaltung <<XPlanDB>> über das Terminal zu verwalten.

[[xplanvalidator-web]]
=== XPlanValidatorWeb

Die Komponente XPlanValidatorWeb ist eine Web-Oberfläche, welche dem
Fachadministrator der xPlanBox ermöglicht,
XPlanGML-Instanzdokumente über den Browser zu validieren.

[[xplanvalidator-wms]]
==== XPlanValidatorWMS

Bei der Komponente XPlanValidatorWMS handelt es sich um eine Subkomponente
des XPlanValidatorWeb. Validierte Plänen können über den XPlanValidatorWMS in der Kartenvorschau angezeigt werden, ohne das ein Plan in die Datenhaltung importiert wird. Dieser Dienst nutzt keine persistente Datenhaltung.

[[xplanvalidator-api]]
=== XPlanValidatorAPI

Die Komponente XPlanValidatorAPI stellt eine REST-Schnittstelle bereit, über die XPlanGML-Instanzdokumente validiert werden können.

[[xplanvalidator-cli]]
=== XPlanValidatorCLI

Die Komponente XPlanValidatorCLI ist ein Kommandozeilenwerkzeug,
welches dem Fachadministrator der xPlanBox ermöglicht,
XPlanGML-Instanzdokumente über das Terminal zu validieren.

[[xplantransform-cli]]
=== XPlanTransformCLI

Die Komponente XPlanTransformCLI ist ein Kommandozeilenwerkzeug,
welches dem Fachadministrator der xPlanBox ermöglicht,
bereits über den XPlanManagerWeb oder das XPlanManagerCLI
importierte Pläne in eine aktuellere XPlanGML Version zu transformieren und in der <<xplandb>> zu speichern.

[[planevaluationschemasynchronize-cli]]
=== XPlanAuswerteschemaCLI

Für die Auswertung des Datenbestands der XPlanDB ist ein dupliziertes Syn-Schema erstellt worden, in dem die Original-Geometrien (wie z.B. Kreisbögen) abgelegt sind. Über das Kommandozeilenwerkzeug XPlanAuswerteschemaCLI kann das Anlegen des Auswerteschemas sowie eine Synchronisierung des Original-Datenbestands mit dem Syn-Schema für die Auswertung erfolgen.

==== Vorbereitung

===== Datenbank

Das Datenbankschema für die Auswertung der XPlanGML-Daten muss durch Ausführen der SQL-Skripte im Ordner _scripts/_ angelegt werden. Folgende Reihenfolge muss beibehalten werden:

1. 00_create_schema.sql
2. 01_create_function.sql
3. 02_create_tables.sql
4. 03_create_trigger-function.sql
5. 04_create_trigger.sql

Diese Skripte erstellen zum einen jeweils eine Kopie der drei Syn-Schemas (lgvxplansyn, lgvxplansynpre und lgvxplansynarchive) und zum anderen eine Log-Tabelle (lgv.lgvPlanTableLog).

Die Log-Tabelle wird beim Importieren, Editieren und Löschen von Plänen über den XPlanManager mit einer Historie der Operationen auf die einzelnen Pläne gefüllt und dient als Basis für die regelmäßige Synchronisation des Syn-Schema aus der xPlanBox und des duplizierte Syn-Schema.

===== GDAL

Damit das Tool ausgeführt werden kann, muss GDAL Version 3.0 plus JNI-Schnittstelle installiert werden.

Zusätzlich muss die Umgebungsvariable `LD_LIBRARY_PATH` (Linux) bzw. `GDAL_DATA` (Windows) gesetzt werden.

Im Betriebshandbuch der xPlanBox in Kapitel "Installation und Konfiguration von GDAL" wird beschrieben, wie die Installation auf Linux und Windows erfolgt.
Für den LgvSynSchemaSynchronizer ist es wichtig, dass die gleiche Version von GDAL installiert wird wie im Betriebshandbuch benannt.

==== Nutzung

Im Verzeichnis _bin/_ steht ein Werkzeug mit dem Namen _EvaluationSchemaSynchronizer_ zur Verfügung, dass wiederum zwei Modi anbietet:

* Option *ALL* zur Überführung aller Pläne aus dem Syn-Schema der xPlanBox in das duplizierte Syn-Schema
* Option *SYNC* um die Synchronisation der seit der letzten Ausführung des Werkzeuges geänderten Pläne aus dem Syn-Schema der xPlanBox in das duplizierte Syn-Schema durchzuführen.

Üblicherweise erfolgt zunächst einmalig die Ausführung der Option *ALL* und anschließend regelmäßig (z.B. nachts mit Hilfe eines Cron-Jobs) die Option *SYNC* um einen tagesaktuellen Stand im duplizierten Syn-Schema zu erreichen.

Die einzelnen Parameter des Werkzeuges können durch folgenden Aufruf abgerufen werden:

-------
EvaluationSchemaSynchronizer -?
-------

==== Beispiel

-------
EvaluationSchemaSynchronizer -p 5432 -h localhost -d xplanbox -u postgres -w postgres -t ALL
-------

[[xplanwms]]
=== XPlanWMS und XPlanWerkWMS

Der XPlanWMS und XPlanWerkWMS sind auf dem Standard Web Map Service
(Version 1.1.1 und 1.3.0) des Open Geospatial Consortium (OGC)
basierende Kartendienste. Diese bieten die Möglichkeit,
Visualisierungen von Plandaten sowie Sachinformationsabfragen zu
einzelnen Planinhalten abzufragen. Um Plandaten zu visualisieren
bzw. Sachinformationen abzufragen, ist es möglich, sowohl eine einfache
(siehe Abbildung 1) als auch eine separate Datenhaltung (siehe Abbildung
2) zu nutzen, in der die Plandaten hinterlegt sind. Dabei wird bei
einer separaten Datenhaltung (Unterteilung in: In Aufstellung, Festgestellt, Archiviert)
durch die Auswahl des Planstatus, die dazugehörige Datenhaltung und
somit der entsprechende XPlanWMS-Endpoint angesprochen. Der XPlanWMS greift auf dasselbe Datenbankschema wie der <<xplansynwfs>> in der <<xplandb>> zu. Rasterdaten werden im Workspace-Verzeichnis des XPlanWMS hinterlegt. Im Anhang <<appendix_xplanwms-workspace>> ist die Verzeichnisstruktur des Workspace dokumentiert.

Während der XPlanWMS planübergreifend arbeitet, beschränkt sich der
XPlanWerkWMS auf einzelne Planwerke.

Die folgende Tabelle zeigt die vom XPlanWMS bereitgestellten Daten nach Planstatus.

[width="100%",cols="30%,40%,30%",options="header"]
|===
|Endpoint
|Planstatus
|Postfix für Schema und Endpoint
|XPlanWMSInAufstellung
|In Aufstellung
|_pre_
|XPlanWMSFestgestellt
|Festgestellt
|-
|XPlanWMSArchiviert
|Archiviert
|_archive_
|===

NOTE: Gleiches gilt für den XPlanWerkWMS, XPlanWFS und XPlanSynWFS

[[xplanwfs]]
=== XPlanWFS

Der XPlanWFS ist ein auf dem Standard Web Feature Service
(Version 1.1.0 und 2.0.0) des Open Geospatial Consortium (OGC)
basierender Dienst zur Abfrage von Vektordaten und stellt Endpunkte für jede XPlanGML-Version bereit. Zu jeder unterstützten XPlanGML-Version stellt die xPlanBox einen XPlanWFS-Endpoint bereit. Jeder Dienst greift auf das zu der XPlanGML-Version passende Datenbankschema in der <<xplandb>> zu. Die Zuordnung der einzelnen Endpunkte zu den Datenbankschemata ist im Kapitel <<datenzugriff-xplandb>> dokumentiert.

[[xplansynwfs]]
=== XPlanSynWFS

Der XPlanSynWFS dient der Abbildung des synthetisierten
XPlanGML-Anwendungsschemas (XPlanSynGML). Dieses stellt eine
vereinfachte und zusammenfassende Form der verschiedenen XPlanGML
Versionen dar. Der XPlanSynWFS greift auf das synthetisierte Datenbankschema in der <<xplandb>> zu.

[[xplaninspirepluwms]]
=== XPlanInspirePluWMS

Der XPlanInspirePluWMS ist ein INSPIRE View Service für die
Bereitstellung importierter Pläne im INSPIRE Datenthema Planned Land Use (PLU).

[[xplaninspirepluwfs]]
=== XPlanInspirePluWFS

Der XPlanInspirePluWFS ist ein INSPIRE Download Service für die
Bereitstellung importierter Pläne im INSPIRE Datenthema Planned Land Use (PLU).

[[xplanresources]]
=== XPlanRessourcen

Die optionale Komponente XPlanRessourcen bietet eine
Einstiegsseite zu den einzelnen Komponenten der xPlanBox und stellt
Testdaten sowie die Dokumente mit den Konformitätsbedingungen des Standards XPlanung bereit.

[[xplandb]]
=== XPlanDB

Die Komponente stellt die zentrale Datenhaltungskomponente für die alle Komponenten der xPlanBox bereit und wird durch eine PostgreSQL/PostGIS DB realisiert. Die Einrichtung der Datenbank ist im Kapitel <<konfiguration-der-datenbank>>, die Datenbankstruktur im Anhang <<appendix_xplandb>> sowie der Datenzugriff im Kapitel <<datenzugriff-xplandb>> beschrieben.