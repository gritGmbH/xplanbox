[appendix]
[[appendix_xplandb]]
== Datenbankmodell der XPlanDB

Die XPlanDB enthält für jede unterstützte XPlanGML-Version ein eigenes Datenbankschema.
Die Datenbankschemata je XPlanGML-Version unterscheiden sich nur im Namen des Schemas. Alle Schemata nutzen das BLOB-Mapping von deegree (siehe https://download.deegree.org/documentation/current/html/#anchor-blob-mode[deegree webservices BLOB mapping]) für die Ablage von XPlanGML-Dokumenten.

[[appendix_xplandb_xplan53]]
=== Datenbankschema für XPlanGML 5.3

Das folgende Diagramm zeigt exemplarisch die Tabellenstruktur aus dem Datenbankschema `xplan53` für die Ablage von XPlanGML-Dokumenten in der Version 5.3.
In der Tabelle `feature_types` werden die in XPlanGML 5.3 enthaltenen Feature Types gespeichert. In der Tabelle `gml_objects` werden die in den XPlanGML-Dokumenten enthaltenen Features in `xplan53.gml_objects.binary_object` gespeichert.

.Datenbankschema 'xplan53' für XPlanGML-Version 5.3
image::xplandb_schema_53.png[Schema xplan53]

Die Tabellenstruktur aus diesem Schema unterscheidet sich nicht zu den anderen von der xPlanBox unterstützten XPlanGML-Versionen. Nur die Inhalte in den jeweiligen `feature_types` Tabellen der anderen Schemata unterscheiden sich je nach XPlanGML-Version.

[[appendix_xplandb_xplansyn]]
=== Datenbankschema für XPlanSyn

Das XPlanSyn-Schema wird aus den von der xPlanBox unterstützten XPlanGML-Versionen abgeleitet. Dabei wird ein versionsübergreifendes Schema erzeugt.
In der aktuellen Version der xPlanBox sind dies die XPlanGML-Versionen 4.0 bis 6.0 und das Datenbankschema `xplansyn` umfasst 247 Tabellen. XPlanGML-Dokumente werden im XPlanSyn-Schema unter Verwendung des relationalen Mappings von deegree (siehe https://download.deegree.org/documentation/current/html/#_mapping_gml_application_schemas[deegree webservices relational mapping]) gespeichert.

IMPORTANT: Wird eine ältere XPlanGML-Version abgekündigt oder eine neue XPlanGML-Version hinzugefügt, ändert sich das XPlanSyn-Schema!

Die folgenden Diagramme zeigen die Tabellenstruktur für ausgewählte Fachdatenobjekte (abgeleitete Feature Types aus dem XPlanGML-Schema) aus dem Schema `xplansyn`.

.Datenbankschema 'xplansyn' - BPlan (Ausschnitt 1 - BP_Baugebiet)
image::xplandb_xplansyn_bplan1.png[Schema xplansyn - BPlan (Ausschnitt 1 - BP_Baugebiet)]

.Datenbankschema 'xplansyn' - BPlan (Ausschnitt 2 - BP_Bereich)
image::xplandb_xplansyn_bplan2.png[Schema xplansyn - BPlan (Ausschnitt 2 - BP_Bereich)]

.Datenbankschema 'xplansyn' - BPlan (Ausschnitt 3 - BP_Plan)
image::xplandb_xplansyn_bplan3.png[Schema xplansyn - BPlan (Ausschnitt 3 - BP_Plan)]

.Datenbankschema 'xplansyn' - BPlan (Ausschnitt 4 - BP_UeberbaubareGrundstuecksflaeche)
image::xplandb_xplansyn_bplan4.png[Schema xplansyn - BPlan (Ausschnitt 4 - BP_UeberbaubareGrundstuecksflaeche)]

.Datenbankschema 'xplansyn' - XP (Ausschnitt 1 - XP_FPO)
image::xplandb_xplansyn_xp1.png[Schema xplansyn - XP (Ausschnitt 1 - XP_FPO)]

.Datenbankschema 'xplansyn' - XP (Ausschnitt 2 - XP_Nutzungsschablone)
image::xplandb_xplansyn_xp2.png[Schema xplansyn - XP (Ausschnitt 2 - XP_Nutzungsschablone)]

[[appendix_xplandb_xplanmgr]]
=== Datenbankschema für XPlanManager

Das Datenbankschema für den XPlanManager enthält neben einigen Informationen aus dem XPlanGML-Dokument auch alle mit dem XPlanArchiv importierten Anhänge.

Das folgende Diagramm zeigt die Tabellenstruktur für das Schema `xplanmgr`.

In der Tabelle `xplanmgr.plans.artefacts` werden alle im XPlanArchiv enthaltenen Dokumente gespeichert. Die Tabelle `xplanmgr.plans.planwerkwmsmetadata` beinhaltet Informationen zum <<xplanwms, XPlanWerkWMS>>.

.Datenbankschema 'xplanmgr'
image::xplandb_xplanmgr.png[Schema xplanmgr]

NOTE: Die Rasterdateien können zusätzlich für die Bereitstellung über den XPlanWMS auch im Workspace des XPlanWMS abgelegt. Die Verzeichnisstruktur im Kapitel <<appendix_xplanwms-workspace>> beschrieben.

NOTE: Die Tabelle `planslog` beinhaltet eine Historie jedes Plans ab dem Zeitpunkt an dem die Tabelle inkl. Function und Trigger angelegt wurde. Die Historie umfasst den Zeitpunkt wann ein Plan importiert (INSERT), aktualisiert (UPDATE) und gelöscht (DELETE) wurde

[[appendix_xplandb_skript]]
=== Skript zur automatisierten Erstellung der XPlanDB

Die XPlanDB kann mit Hilfe des Bash-Skripts `setup_db.sh` (Datei liegt im https://gitlab.opencode.de/diplanung/ozgxplanung/-/blob/main/xplan-resources/xplan-sql-scripts/setup_db.sh[Open CoDE GitLab-Repository]) aufgesetzt werden.
Das Skript verwendet folgende Umgebungsvariablen, die vom Kommandozeilenwerkzeug `psql` ausgelesen werden (siehe https://www.postgresql.org/docs/current/libpq-envars.html[PostgreSQL Dokumentation]):

- `PGUSER`: Name des Datenbankbenutzers mit Super User Rolle (default: _postgres_, required)
- `PGPASSWORD`: Passwort des Super Users (default: _<NOT_SET>_, optional)
- `PGHOST`: Name des Hosts (default: localhost, optional)
- `PGPORT`: Portadresse der Datenbank (default: 5432, optional)
- `DB_NAME`: Name der Datenbank (default: _xplanbox_, variable: `XPLAN_DB_NAME`, optional)
- `DB_USER`: Name des Datenbankbenutzers (default: _xplanbox_, variable: `XPLAN_DB_USER`, optional)
- `DB_PASSWORD`: Passwort des Datenbankbenutzers (default: _xplanbox_, variable: `XPLAN_DB_PASSWORD`, optional)
- `DB_INIT_USER`: Name des Datenbankbenutzers zum Aufsetzen der Datenbank, Rolle erfordert erweiterte Berechtigungen (default: _initxplanbox_, variable: `XPLAN_DB_INIT_USER`, optional)
- `DB_INIT_PASSWORD`: Passwort des Datenbankbenutzers (default: _initxplanbox_, variable: `XPLAN_DB_INIT_PASSWORD`, optional)

Beispiel für den Aufruf des Skripts:

```shell
PGHOST=localhost PGPORT=5432 PGUSER=postgres PGPASSWORD=mysecretpassword XPLAN_DB_NAME=xplanung-db ./setup_db.sh
```