stages:
  - build

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN"
  MAVEN_CLI_OPTS: "--batch-mode -DinstallAtEnd=true -DdeployAtEnd=true -s $CI_PROJECT_DIR/ci_settings.xml"

maven-build:
  stage: build
  image: maven:3.8.6-jdk-11
  script:
    - 'echo "with Maven goal: $MAVEN_GOAL"'
    - 'curl -o geowerkstatt-hamburg-xplanung.zip https://bitbucket.org/geowerkstatt-hamburg/xplanung/get/v0.11.1.zip'
    - 'mvn -q $MAVEN_CLI_OPTS install:install-file -DgroupId=de.geowerkstatt-hamburg -DartifactId=xplanung -Dversion=0.11.1 -Dpackaging=zip -DgeneratePom=true -Dfile=geowerkstatt-hamburg-xplanung.zip'
    - 'git clone --branch xplanbox-deegree-3.4.27 https://github.com/lat-lon/deegree3.git'
    - 'cd deegree3'
    - 'mvn -q $MAVEN_CLI_OPTS install -DskipTests'
    - 'cd ..'
    - 'mvn $MAVEN_CLI_OPTS $MAVEN_GOAL -DskipTests'
  rules:
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      variables:
        MAVEN_GOAL: "install"
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      variables:
        MAVEN_GOAL: "deploy"
